# VPipe å¿«é€Ÿå…¥é—¨ - ä»é›¶åˆ°ç²¾é€š

## ğŸ¯ æ¬¢è¿

æ¬¢è¿å­¦ä¹ VPipeï¼è¿™æ˜¯ä¸€ä¸ªå…ˆè¿›çš„æµæ°´çº¿å¹¶è¡Œè®­ç»ƒæ¡†æ¶ã€‚æœ¬æŒ‡å—å°†å¸®åŠ©ä½ å¿«é€Ÿä¸Šæ‰‹ã€‚

---

## ğŸ“š æ–‡æ¡£å¯¼èˆª

æˆ‘ä¸ºä½ å‡†å¤‡äº†ä»¥ä¸‹å­¦ä¹ èµ„æ–™ï¼š

| æ–‡æ¡£ | é€‚åˆäººç¾¤ | ä¸»è¦å†…å®¹ |
|------|----------|----------|
| **[å­¦ä¹ æŒ‡å—.md](./å­¦ä¹ æŒ‡å—.md)** | æ‰€æœ‰äºº | å®Œæ•´å­¦ä¹ è·¯å¾„ã€æ ¸å¿ƒæ¦‚å¿µã€æ¨èé˜…è¯»é¡ºåº |
| **[å˜é‡é€ŸæŸ¥è¡¨.md](./å˜é‡é€ŸæŸ¥è¡¨.md)** | ç¼–ç æ—¶å‚è€ƒ | æ‰€æœ‰é‡è¦å˜é‡çš„å«ä¹‰å’Œç¤ºä¾‹å€¼ |
| **[ä»£ç èµ°æŸ¥å®æˆ˜.md](./ä»£ç èµ°æŸ¥å®æˆ˜.md)** | æ·±å…¥å­¦ä¹  | å…·ä½“ä»£ç æ‰§è¡Œæµç¨‹ã€å®æˆ˜è°ƒè¯•æŠ€å·§ |
| **æœ¬æ–‡æ¡£** | å¿«é€Ÿå…¥é—¨ | 5åˆ†é’Ÿäº†è§£é¡¹ç›®ï¼Œ30åˆ†é’Ÿè¿è¡Œç¬¬ä¸€ä¸ªå®éªŒ |

---

## ğŸš€ 5åˆ†é’Ÿå¿«é€Ÿç†è§£

### VPipeæ˜¯ä»€ä¹ˆï¼Ÿ

VPipe = **æµæ°´çº¿å¹¶è¡Œ** + **å¼‚æ­¥è°ƒåº¦** + **æƒé‡å­˜å‚¨**

```
ä¼ ç»Ÿè®­ç»ƒ: [GPU0: æ•´ä¸ªæ¨¡å‹] -> OOM (å†…å­˜ä¸è¶³)

æµæ°´çº¿å¹¶è¡Œ:
[GPU0: Layer 0-12] -> [GPU1: Layer 13-25] -> [GPU2: Layer 26-38] -> [GPU3: Layer 39-49]
   â†“                      â†“                      â†“                      â†“
  Stage 0               Stage 1                Stage 2                Stage 3
```

### æ ¸å¿ƒä¼˜åŠ¿

| æ–¹æ³• | ååé‡ | å†…å­˜æ•ˆç‡ | é€šä¿¡å¼€é”€ |
|------|--------|----------|----------|
| æ•°æ®å¹¶è¡Œ | é«˜ | ä½ (æ¯GPUå­˜å®Œæ•´æ¨¡å‹) | ä½ |
| æ¨¡å‹å¹¶è¡Œ | ä½ (GPUé—²ç½®) | é«˜ | é«˜ |
| GPipe | ä¸­ (åŒæ­¥ç­‰å¾…) | é«˜ | ä¸­ |
| PipeDream | é«˜ (å¼‚æ­¥) | ä¸­ (å¤šç‰ˆæœ¬æƒé‡) | ä¸­ |
| **VPipe** | **æœ€é«˜** | **é«˜** | **ä¸­** |

### å…³é”®æŠ€æœ¯

1. **Pipeline Parallelism (æµæ°´çº¿å¹¶è¡Œ)**
   - æ¨¡å‹æŒ‰å±‚åˆ‡åˆ†åˆ°å¤šä¸ªGPU
   - ç±»ä¼¼å·¥å‚æµæ°´çº¿ï¼Œè¿ç»­å¤„ç†å¤šä¸ªminibatch

2. **ASP (Asynchronous Stale Parameter)**
   - ä¸ç­‰å¾…æ‰€æœ‰GPUå®Œæˆï¼ŒæŒç»­æ¨è¿›
   - å…è®¸ä½¿ç”¨"é™ˆæ—§"çš„æƒé‡ç‰ˆæœ¬

3. **Weight Stashing (æƒé‡å­˜å‚¨)**
   - ä¿å­˜å¤šä¸ªæƒé‡ç‰ˆæœ¬
   - ç¡®ä¿æ¢¯åº¦å¯¹åº”æ­£ç¡®çš„æƒé‡ç‰ˆæœ¬

4. **Activation Recomputation (æ¿€æ´»é‡è®¡ç®—)**
   - ä¸ä¿å­˜æ‰€æœ‰ä¸­é—´æ¿€æ´»å€¼
   - åå‘æ—¶é‡æ–°è®¡ç®—ï¼ŒèŠ‚çœå†…å­˜

---

## ğŸƒ 30åˆ†é’Ÿè¿è¡Œç¬¬ä¸€ä¸ªå®éªŒ(slurmé›†ç¾¤)

### å‰ç½®å‡†å¤‡

```bash
# 1. æ£€æŸ¥ç¯å¢ƒ
nvidia-smi  # ç¡®ä¿æœ‰GPU
python --version  # Python 3.7+
pip list | grep torch  # PyTorch 1.7+

# 2. è¿›å…¥é¡¹ç›®ç›®å½•
cd /home/lzx4ubuntu2204/workspace/research/study/vpipe/runtime

# 3. æ£€æŸ¥é…ç½®æ–‡ä»¶
cat configs/bert_4vpipe.yml
```

### è¿è¡Œä½ çš„ç¬¬ä¸€ä¸ªå®éªŒ

1. æŒ‰ç…§å®˜æ–¹æ–‡æ¡£å‡†å¤‡å¥½æ•°æ®
2. æŒ‰ç…§å®˜æ–¹æ–‡æ¡£å‡†å¤‡å¥½é•œåƒ
3. ä¿®æ”¹ç›¸åº”çš„å‚æ•°é…ç½®
```bash
sbatch ../run_vpipe.sh
```


### æŸ¥çœ‹è¾“å‡º

```bash
# æ‰¾åˆ°è¾“å‡ºç›®å½•
ls /data/run01/scw6doz/lzx_out/vpipe/output/

# æŸ¥çœ‹æœ€æ–°çš„æ—¥å¿—
cd /data/run01/scw6doz/lzx_out/vpipe/output/$(ls -t | head -1)
tail -f output.log.0
```

é¢„æœŸè¾“å‡ºï¼š
```
Finished initializing process group; backend: gloo, rank: 0, world_size: 4
[Rank 0] Stage: 0, Rank in stage: 0
Training...
Epoch 0, Iteration 0, Loss: 10.8234
Epoch 0, Iteration 100, Loss: 8.3421
...
```

---
