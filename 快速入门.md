# VPipe 快速入门 - 从零到精通

## 🎯 欢迎

欢迎学习VPipe！这是一个先进的流水线并行训练框架。本指南将帮助你快速上手。

---

## 📚 文档导航

我为你准备了以下学习资料：

| 文档 | 适合人群 | 主要内容 |
|------|----------|----------|
| **[学习指南.md](./学习指南.md)** | 所有人 | 完整学习路径、核心概念、推荐阅读顺序 |
| **[变量速查表.md](./变量速查表.md)** | 编码时参考 | 所有重要变量的含义和示例值 |
| **[代码走查实战.md](./代码走查实战.md)** | 深入学习 | 具体代码执行流程、实战调试技巧 |
| **本文档** | 快速入门 | 5分钟了解项目，30分钟运行第一个实验 |

---

## 🚀 5分钟快速理解

### VPipe是什么？

VPipe = **流水线并行** + **异步调度** + **权重存储**

```
传统训练: [GPU0: 整个模型] -> OOM (内存不足)

流水线并行:
[GPU0: Layer 0-12] -> [GPU1: Layer 13-25] -> [GPU2: Layer 26-38] -> [GPU3: Layer 39-49]
   ↓                      ↓                      ↓                      ↓
  Stage 0               Stage 1                Stage 2                Stage 3
```

### 核心优势

| 方法 | 吞吐量 | 内存效率 | 通信开销 |
|------|--------|----------|----------|
| 数据并行 | 高 | 低 (每GPU存完整模型) | 低 |
| 模型并行 | 低 (GPU闲置) | 高 | 高 |
| GPipe | 中 (同步等待) | 高 | 中 |
| PipeDream | 高 (异步) | 中 (多版本权重) | 中 |
| **VPipe** | **最高** | **高** | **中** |

### 关键技术

1. **Pipeline Parallelism (流水线并行)**
   - 模型按层切分到多个GPU
   - 类似工厂流水线，连续处理多个minibatch

2. **ASP (Asynchronous Stale Parameter)**
   - 不等待所有GPU完成，持续推进
   - 允许使用"陈旧"的权重版本

3. **Weight Stashing (权重存储)**
   - 保存多个权重版本
   - 确保梯度对应正确的权重版本

4. **Activation Recomputation (激活重计算)**
   - 不保存所有中间激活值
   - 反向时重新计算，节省内存

---

## 🏃 30分钟运行第一个实验(slurm集群)

### 前置准备

```bash
# 1. 检查环境
nvidia-smi  # 确保有GPU
python --version  # Python 3.7+
pip list | grep torch  # PyTorch 1.7+

# 2. 进入项目目录
cd /home/lzx4ubuntu2204/workspace/research/study/vpipe/runtime

# 3. 检查配置文件
cat configs/bert_4vpipe.yml
```

### 运行你的第一个实验

1. 按照官方文档准备好数据
2. 按照官方文档准备好镜像
3. 修改相应的参数配置
```bash
sbatch ../run_vpipe.sh
```


### 查看输出

```bash
# 找到输出目录
ls /data/run01/scw6doz/lzx_out/vpipe/output/

# 查看最新的日志
cd /data/run01/scw6doz/lzx_out/vpipe/output/$(ls -t | head -1)
tail -f output.log.0
```

预期输出：
```
Finished initializing process group; backend: gloo, rank: 0, world_size: 4
[Rank 0] Stage: 0, Rank in stage: 0
Training...
Epoch 0, Iteration 0, Loss: 10.8234
Epoch 0, Iteration 100, Loss: 8.3421
...
```

---
