# VPipe å­¦ä¹ è·¯çº¿å›¾

## ğŸ“Š æ¦‚å¿µå…³ç³»å›¾

```
                                    VPipeç³»ç»Ÿ
                                        |
                 _______________________ ______________________
                |                       |                      |
         æµæ°´çº¿å¹¶è¡Œ                  å¼‚æ­¥è°ƒåº¦              æƒé‡å­˜å‚¨
      (Pipeline Parallel)          (ASP Mode)         (Weight Stashing)
                |                       |                      |
         Stageåˆ‡åˆ†                   1F1Bè°ƒåº¦              Version Queue
         Partition                 ä¸ç­‰å¾…åŒæ­¥             ä¿å­˜å¤šç‰ˆæœ¬æƒé‡
                |                       |                      |
         ________|________        _______|_______         _____|_____
        |                |       |               |       |           |
     æ¨¡å‹å±‚            æ¿€æ´»å€¼   Forward       Backward   æ—§ç‰ˆæœ¬    æ–°ç‰ˆæœ¬
     åˆ†é…æ–¹æ¡ˆ          é€šä¿¡     Minibatch    Minibatch   åº”ç”¨æ¢¯åº¦  å‰å‘æ¨ç†
```

## ğŸ¯ å­¦ä¹ è·¯å¾„æ€»è§ˆ

```
ç¬¬ä¸€é˜¶æ®µ (Day 1-2)          ç¬¬äºŒé˜¶æ®µ (Day 3-4)         ç¬¬ä¸‰é˜¶æ®µ (Day 5-6)        ç¬¬å››é˜¶æ®µ (Day 7)
  å®è§‚ç†è§£                    ä»£ç æ‰§è¡Œæµç¨‹               æ·±å…¥æ ¸å¿ƒæœºåˆ¶             å®éªŒè°ƒä¼˜
     |                            |                          |                      |
     v                            v                          v                      v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç†è§£æ¶æ„    â”‚           â”‚ driver.py    â”‚          â”‚ é€šä¿¡æœºåˆ¶     â”‚        â”‚ è¿è¡Œå®éªŒ    â”‚
â”‚ Stage/Rank  â”‚  -------> â”‚ main_with... â”‚  ------> â”‚ Weight       â”‚  ----> â”‚ æ€§èƒ½å¯¹æ¯”    â”‚
â”‚ Pipeline    â”‚           â”‚ runtime.py   â”‚          â”‚ Stashing     â”‚        â”‚ å‚æ•°è°ƒä¼˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     |                            |                          |                      |
è¯»å­¦ä¹ æŒ‡å—               æ·»åŠ æ‰“å°è¯­å¥                 æŸ¥å˜é‡é€ŸæŸ¥è¡¨          ä¿®æ”¹é…ç½®æ–‡ä»¶
ç”»æµç¨‹å›¾                 å•æ­¥è¿½è¸ª                     ç†è§£é˜Ÿåˆ—æœºåˆ¶          åˆ†ææ—¥å¿—
```


## ğŸ—ºï¸ æ ¸å¿ƒçŸ¥è¯†åœ°å›¾

### 1. æ¶æ„å±‚

```
VPipeç³»ç»Ÿæ¶æ„
â”‚
â”œâ”€â”€ å¯åŠ¨å±‚ (driver.py)
â”‚   â”œâ”€â”€ è§£æYAMLé…ç½®
â”‚   â”œâ”€â”€ æ„å»ºæœºå™¨åˆ—è¡¨
â”‚   â”œâ”€â”€ å¯åŠ¨Singularityå®¹å™¨
â”‚   â””â”€â”€ åˆ†å‘è¿è¡Œå‘½ä»¤
â”‚
â”œâ”€â”€ è®­ç»ƒå±‚ (main_with_runtime.py)
â”‚   â”œâ”€â”€ åˆå§‹åŒ–åˆ†å¸ƒå¼ç¯å¢ƒ
â”‚   â”œâ”€â”€ åŠ è½½æ•°æ®é›†
â”‚   â”œâ”€â”€ æ„å»ºæ¨¡å‹å’Œpartition
â”‚   â”œâ”€â”€ åˆ›å»ºoptimizer
â”‚   â””â”€â”€ æ‰§è¡Œè®­ç»ƒå¾ªç¯
â”‚
â”œâ”€â”€ è¿è¡Œæ—¶å±‚ (runtime.py)
â”‚   â”œâ”€â”€ StageRuntimeåˆå§‹åŒ–
â”‚   â”œâ”€â”€ å‰å‘ä¼ æ’­ç®¡ç†
â”‚   â”œâ”€â”€ åå‘ä¼ æ’­ç®¡ç†
â”‚   â””â”€â”€ æµæ°´çº¿è°ƒåº¦
â”‚
â””â”€â”€ é€šä¿¡å±‚ (communication.py)
    â”œâ”€â”€ è¿›ç¨‹ç»„ç®¡ç†
    â”œâ”€â”€ ç‚¹å¯¹ç‚¹é€šä¿¡
    â”œâ”€â”€ å¹¿æ’­é€šä¿¡
    â””â”€â”€ å¼‚æ­¥çº¿ç¨‹æ± 
```

### 2. æ¦‚å¿µå±‚

```
æ ¸å¿ƒæ¦‚å¿µä½“ç³»
â”‚
â”œâ”€â”€ å¹¶è¡Œç»´åº¦
â”‚   â”œâ”€â”€ æµæ°´çº¿å¹¶è¡Œ (Pipeline): æ¨¡å‹åˆ‡åˆ†åˆ°å¤šä¸ªGPU
â”‚   â”œâ”€â”€ æ•°æ®å¹¶è¡Œ (Data): åŒä¸€stageå†…å¤šGPU
â”‚   â””â”€â”€ å¼ é‡å¹¶è¡Œ (Tensor): (æœªå®ç°ï¼Œåœ¨cpmç›®å½•å¼€å‘ä¸­)
â”‚
â”œâ”€â”€ æµæ°´çº¿æ¦‚å¿µ
â”‚   â”œâ”€â”€ Stage: è¿ç»­çš„è‹¥å¹²å±‚
â”‚   â”œâ”€â”€ Minibatch: Batchçš„å­é›†
â”‚   â”œâ”€â”€ Warmup: å¡«å……æµæ°´çº¿
â”‚   â”œâ”€â”€ 1F1B: One Forward One Backward
â”‚   â””â”€â”€ Cooldown: æ’ç©ºæµæ°´çº¿
â”‚
â”œâ”€â”€ é€šä¿¡æ¦‚å¿µ
â”‚   â”œâ”€â”€ Rank: è¿›ç¨‹æ ‡è¯†
â”‚   â”œâ”€â”€ Tensor Tag: é€šä¿¡æ ‡è¯†
â”‚   â”œâ”€â”€ Send/Recv: ç‚¹å¯¹ç‚¹é€šä¿¡
â”‚   â””â”€â”€ Broadcast: å¹¿æ’­é€šä¿¡
â”‚
â””â”€â”€ ä¼˜åŒ–æŠ€æœ¯
    â”œâ”€â”€ Weight Stashing: å¤šç‰ˆæœ¬æƒé‡
    â”œâ”€â”€ Recomputation: æ¿€æ´»å€¼é‡è®¡ç®—
    â”œâ”€â”€ ASP: å¼‚æ­¥é™ˆæ—§å‚æ•°
    â””â”€â”€ Gradient Clipping: æ¢¯åº¦è£å‰ª
```

### 3. æ•°æ®æµå±‚

```
æ•°æ®æµåŠ¨è·¯å¾„
â”‚
Dataset
  â”‚
  v
DataLoader (ä»…Stage 0)
  â”‚
  v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 0 â”‚ input_ids, attention_mask, labels
â”‚         â”‚ â†“ Forward
â”‚         â”‚ out12 (æ¿€æ´»å€¼)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ send
     v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1 â”‚ â† recv out12
â”‚         â”‚ â†“ Forward
â”‚         â”‚ out25 (æ¿€æ´»å€¼)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ send
     v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 2 â”‚ â† recv out25
â”‚         â”‚ â†“ Forward
â”‚         â”‚ out38 (æ¿€æ´»å€¼)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ send
     v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 3 â”‚ â† recv out38
â”‚         â”‚ â†“ Forward + Loss
â”‚ (Loss)  â”‚ â†“ Backward
â”‚         â”‚ grad_out38 (æ¢¯åº¦)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ send
     v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 2 â”‚ â† recv grad_out38
â”‚         â”‚ â†“ Backward
â”‚         â”‚ grad_out25 (æ¢¯åº¦)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ send
     v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1 â”‚ â† recv grad_out25
â”‚         â”‚ â†“ Backward
â”‚         â”‚ grad_out12 (æ¢¯åº¦)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ send
     v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 0 â”‚ â† recv grad_out12
â”‚         â”‚ â†“ Backward
â”‚         â”‚ æ›´æ–°æƒé‡
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“‹ çŸ¥è¯†ç‚¹æ¸…å•

### å¿…é¡»æŒæ¡ âœ…

- [ ] Stage vs Rank vs GPU çš„åŒºåˆ«
- [ ] Pipelineå¹¶è¡Œçš„åŸºæœ¬åŸç†
- [ ] 1F1Bè°ƒåº¦ç­–ç•¥
- [ ] Warmup/Cooldowné˜¶æ®µ
- [ ] send_ranks å’Œ receive_ranks çš„æ„å»º
- [ ] tensor_tags çš„ä½œç”¨
- [ ] Weight Stashing çš„å¿…è¦æ€§
- [ ] å¦‚ä½•è¿è¡ŒåŸºç¡€å®éªŒ

### åº”è¯¥ç†è§£ ğŸ”¶

- [ ] driver.py çš„å¯åŠ¨æµç¨‹
- [ ] StageRuntime çš„åˆå§‹åŒ–è¿‡ç¨‹
- [ ] CommunicationHandler çš„å·¥ä½œæœºåˆ¶
- [ ] OptimizerWithWeightStashing çš„å®ç°
- [ ] partitioné…ç½®å¦‚ä½•å½±å“æ€§èƒ½
- [ ] recompute_ratio çš„å†…å­˜-æ—¶é—´æƒè¡¡
- [ ] ASP vs BSP çš„åŒºåˆ«
- [ ] å¦‚ä½•è°ƒè¯•å’Œå®šä½é—®é¢˜

### å¯ä»¥æ‰©å±• ğŸŒŸ

- [ ] BERTæ¨¡å‹çš„åˆ‡åˆ†å®ç° (vpipe.py)
- [ ] æ¿€æ´»é‡è®¡ç®—çš„è¯¦ç»†æœºåˆ¶
- [ ] å¤šèŠ‚ç‚¹é€šä¿¡çš„ä¼˜åŒ–
- [ ] 3Då¹¶è¡Œ (Pipeline + Data + Tensor)
- [ ] åŠ¨æ€è°ƒåº¦ç­–ç•¥
- [ ] ä¸ºæ–°æ¨¡å‹ç¼–å†™åˆ‡åˆ†ä»£ç 
- [ ] é€šä¿¡å‹ç¼©æŠ€æœ¯
- [ ] æ€§èƒ½profilingå’Œä¼˜åŒ–


## ğŸ” å¿«é€ŸæŸ¥æ‰¾ç´¢å¼•

### æŒ‰æ¦‚å¿µæŸ¥æ‰¾

| æ¦‚å¿µ | å®šä¹‰ä½ç½® | å®ç°ä½ç½® | ç¤ºä¾‹ä½ç½® |
|------|----------|----------|----------|
| Stage | å­¦ä¹ æŒ‡å— Â§æ ¸å¿ƒæ¦‚å¿µ1 | runtime.py:147 | ä»£ç èµ°æŸ¥ å®æˆ˜2 |
| Rank | å­¦ä¹ æŒ‡å— Â§æ ¸å¿ƒæ¦‚å¿µ2 | runtime.py:86 | ä»£ç èµ°æŸ¥ å®æˆ˜2 |
| Minibatch | å­¦ä¹ æŒ‡å— Â§æ ¸å¿ƒæ¦‚å¿µ3 | runtime.py:90-91 | ä»£ç èµ°æŸ¥ å®æˆ˜3 |
| Weight Stashing | å­¦ä¹ æŒ‡å— Â§æ ¸å¿ƒæ¦‚å¿µ5 | optimizer.py:21 | ä»£ç èµ°æŸ¥ å®æˆ˜5 |
| Recomputation | å­¦ä¹ æŒ‡å— Â§æ ¸å¿ƒæ¦‚å¿µ6 | bert/vpipe.py:49 | ä»£ç èµ°æŸ¥ å®æˆ˜6 |
| send_ranks | å˜é‡é€ŸæŸ¥è¡¨ Â§é€šä¿¡ | runtime.py:84 | ä»£ç èµ°æŸ¥ å®æˆ˜4 |
| tensor_tags | å˜é‡é€ŸæŸ¥è¡¨ Â§é€šä¿¡ | runtime.py:89 | ä»£ç èµ°æŸ¥ å®æˆ˜4 |
| partition | å­¦ä¹ æŒ‡å— Â§é…ç½®æ–‡ä»¶ | configs/*.json | ä»£ç èµ°æŸ¥ å®æˆ˜2 |

### æŒ‰æ–‡ä»¶æŸ¥æ‰¾

| æ–‡ä»¶ | ä¸»è¦åŠŸèƒ½ | å…³é”®ç±»/å‡½æ•° | è¯¦è§£ä½ç½® |
|------|----------|-------------|----------|
| driver.py | å¯åŠ¨åˆ†å¸ƒå¼è®­ç»ƒ | main | ä»£ç èµ°æŸ¥ å®æˆ˜1 |
| runtime.py | æµæ°´çº¿è¿è¡Œæ—¶ | StageRuntime | ä»£ç èµ°æŸ¥ å®æˆ˜2-3 |
| communication.py | é€šä¿¡ç®¡ç† | CommunicationHandler | ä»£ç èµ°æŸ¥ å®æˆ˜4 |
| optimizer.py | æƒé‡å­˜å‚¨ | OptimizerWithWeightStashing | ä»£ç èµ°æŸ¥ å®æˆ˜5 |
| bert/vpipe.py | BERTåˆ‡åˆ† | Bert, Stage | ä»£ç èµ°æŸ¥ å®æˆ˜6 |
| bert/main_with_runtime.py | è®­ç»ƒä¸»ç¨‹åº | train, stage | ä»£ç èµ°æŸ¥ å®æˆ˜2 |

### æŒ‰åŠŸèƒ½æŸ¥æ‰¾

| åŠŸèƒ½ | ç›¸å…³æ–‡ä»¶ | å…³é”®ä»£ç  | å­¦ä¹ èµ„æ–™ |
|------|----------|----------|----------|
| æ¨¡å‹åˆ‡åˆ† | bert/vpipe.py | generate_stage | å­¦ä¹ æŒ‡å— Â§é˜¶æ®µä¸‰5 |
| å¯åŠ¨è®­ç»ƒ | driver.py | Line 267-313 | ä»£ç èµ°æŸ¥ å®æˆ˜1 |
| å‰å‘ä¼ æ’­ | runtime.py | run_forward | ä»£ç èµ°æŸ¥ å®æˆ˜3 |
| åå‘ä¼ æ’­ | runtime.py | run_backward | ä»£ç èµ°æŸ¥ å®æˆ˜3 |
| å‘é€å¼ é‡ | runtime.py, communication.py | send_tensors_forward, send | ä»£ç èµ°æŸ¥ å®æˆ˜4 |
| æ¥æ”¶å¼ é‡ | runtime.py, communication.py | receive_tensors_forward, recv | ä»£ç èµ°æŸ¥ å®æˆ˜4 |
| æƒé‡æ›´æ–° | optimizer.py | step | ä»£ç èµ°æŸ¥ å®æˆ˜5 |
| é‡è®¡ç®— | bert/vpipe.py | cp_forward | ä»£ç èµ°æŸ¥ å®æˆ˜6 |

## ğŸ’ æ ¸å¿ƒä»£ç ç‰‡æ®µç´¢å¼•

### 1. Pipelineè°ƒåº¦æ ¸å¿ƒå¾ªç¯

**ä½ç½®**: runtime.py, run_training_iteration()
```python
# Warmup
for i in range(num_warmup_minibatches):
    receive_tensors_forward()
    run_forward()
    send_tensors_forward()

# Steady (1F1B)
for i in range(num_iterations - num_warmup_minibatches):
    receive_tensors_forward()
    run_forward()
    send_tensors_forward()
    receive_tensors_backward()
    run_backward()
    send_tensors_backward()

# Cooldown
for i in range(num_warmup_minibatches):
    receive_tensors_backward()
    run_backward()
    send_tensors_backward()
```
**å­¦ä¹ **: ä»£ç èµ°æŸ¥å®æˆ˜.md Â§å®æˆ˜3

### 2. é€šä¿¡æ ¸å¿ƒé€»è¾‘

**ä½ç½®**: communication.py, send()/recv()
```python
# å‘é€
tag = tensor_tags[tensor_name] * 100000 + minibatch_id
dist.send(tensor, dst=dst_rank, tag=tag)

# æ¥æ”¶
tag = tensor_tags[tensor_name] * 100000 + minibatch_id
dist.recv(buffer, src=src_rank, tag=tag)
```
**å­¦ä¹ **: ä»£ç èµ°æŸ¥å®æˆ˜.md Â§å®æˆ˜4

### 3. Weight Stashingæ ¸å¿ƒé€»è¾‘

**ä½ç½®**: optimizer.py, step()
```python
# 1. åŠ è½½æ—§ç‰ˆæœ¬æƒé‡
load_old_params()  # ä»é˜Ÿåˆ—å¤´éƒ¨

# 2. åº”ç”¨æ¢¯åº¦
base_optimizer.step()

# 3. ä¿å­˜æ–°ç‰ˆæœ¬
queue.append(get_params(clone=True))

# 4. æ›´æ–°ç‰ˆæœ¬å·
latest_version = latest_version.incr()
current_version = current_version.incr()

# 5. åŠ è½½æ–°ç‰ˆæœ¬
load_new_params()  # ä½¿ç”¨é˜Ÿåˆ—å°¾éƒ¨
```
**å­¦ä¹ **: ä»£ç èµ°æŸ¥å®æˆ˜.md Â§å®æˆ˜5

### 4. æ¨¡å‹åˆ‡åˆ†æ ¸å¿ƒé€»è¾‘

**ä½ç½®**: bert/vpipe.py, Stage.__init__()
```python
# æ ¹æ®recompute_ratioåˆ‡åˆ†
back = int(fraction * len(calcus))

if back > 0:
    # å‰é¢çš„layersæ­£å¸¸æ‰§è¡Œ
    no_cp_ = calcus[:-back]
    
    # åé¢çš„layersä½¿ç”¨checkpoint
    cp_ = calcus[-back:]
    cp_out = cp.checkpoint(self.cp_forward, ...)
```
**å­¦ä¹ **: ä»£ç èµ°æŸ¥å®æˆ˜.md Â§å®æˆ˜6
